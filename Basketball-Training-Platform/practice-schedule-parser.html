<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Time Finder - Coach D</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;

        const ScheduleParser = () => {
            const [myPractices, setMyPractices] = useState([]);
            const [openPractices, setOpenPractices] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [spreadsheetUrl, setSpreadsheetUrl] = useState('');
            const [lastUpdated, setLastUpdated] = useState(null);
            const [filterGyms, setFilterGyms] = useState({
                eastRidge: true,
                lakeMiddle: true,
                oltman: true,
                woodburyHS: true,
                other: true
            });
            const [hideElementary, setHideElementary] = useState(true);

            const preferredGyms = [
                'East Ridge',
                'Lake Middle',
                'Oltman',
                'Woodbury High School',
                'Woodbury HS'
            ];

            const isElementarySchool = (gym) => {
                const elementary = ['Bailey', 'Crestview', 'Newport', 'Red Rock', 'Royal Oaks', 
                                   'Valley Crossing', 'Woodbury Elem', 'Brookview'];
                return elementary.some(elem => gym.includes(elem));
            };

            const categorizeGym = (gym) => {
                if (gym.includes('East Ridge')) return 'eastRidge';
                if (gym.includes('Lake Middle')) return 'lakeMiddle';
                if (gym.includes('Oltman')) return 'oltman';
                if (gym.includes('Woodbury High') || gym.includes('Woodbury HS')) return 'woodburyHS';
                return 'other';
            };

            const parseSchedule = useCallback((csvData) => {
                setLoading(true);
                setError(null);

                try {
                    const lines = csvData.split('\n');
                    const dateRow = lines[7]; // Row 8 in 1-indexed (row 7 in 0-indexed)
                    
                    // Parse date row - skip first column (gym location header)
                    const dateColumns = dateRow.split(',').slice(1);
                    const dates = dateColumns.map(d => d.trim().replace(/"/g, ''));
                    
                    const mySchedule = [];
                    const openSchedule = [];

                    // Parse each line looking for Simmons or HS Open  
                    for (let i = 9; i < lines.length; i++) {
                        const line = lines[i];
                        if (!line.trim()) continue;

                        // Extract gym name (first column)
                        const firstComma = line.indexOf(',');
                        if (firstComma === -1) continue;
                        
                        let gym = line.substring(0, firstComma).trim().replace(/^"|"$/g, '');
                        
                        // Parse the rest of the columns
                        const columns = line.substring(firstComma + 1).split(',');
                        
                        columns.forEach((cell, idx) => {
                            const cleanCell = cell.trim().replace(/"/g, '');
                            
                            if (cleanCell.includes('Simmons') && !cleanCell.includes('HS Open')) {
                                const date = dates[idx];
                                if (date && date.includes('/')) {
                                    mySchedule.push({
                                        date,
                                        gym,
                                        team: cleanCell,
                                        category: categorizeGym(gym),
                                        isElementary: isElementarySchool(gym)
                                    });
                                }
                            }
                            
                            if (cleanCell === 'HS Open') {
                                const date = dates[idx];
                                if (date && date.includes('/')) {
                                    openSchedule.push({
                                        date,
                                        gym,
                                        category: categorizeGym(gym),
                                        isElementary: isElementarySchool(gym)
                                    });
                                }
                            }
                        });
                    }

                    // Sort by date
                    const sortByDate = (a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateA - dateB;
                    };

                    mySchedule.sort(sortByDate);
                    openSchedule.sort(sortByDate);

                    setMyPractices(mySchedule);
                    setOpenPractices(openSchedule);
                    setLastUpdated(new Date());
                } catch (err) {
                    setError('Error parsing schedule: ' + err.message);
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }, []);

            const fetchFromUrl = async () => {
                if (!spreadsheetUrl) {
                    setError('Please enter a spreadsheet URL');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    // Convert Google Sheets URL to CSV export URL if needed
                    let fetchUrl = spreadsheetUrl;
                    if (spreadsheetUrl.includes('docs.google.com/spreadsheets')) {
                        const sheetId = spreadsheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                        if (sheetId) {
                            fetchUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                        }
                    }

                    const response = await fetch(fetchUrl);
                    if (!response.ok) {
                        throw new Error('Failed to fetch spreadsheet. Make sure it\'s publicly accessible.');
                    }
                    
                    const csvData = await response.text();
                    parseSchedule(csvData);
                } catch (err) {
                    setError('Error fetching spreadsheet: ' + err.message);
                    setLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    parseSchedule(event.target.result);
                };
                reader.readAsText(file);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const file = e.dataTransfer.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    parseSchedule(event.target.result);
                };
                reader.readAsText(file);
            };

            const filteredOpenPractices = openPractices.filter(practice => {
                if (hideElementary && practice.isElementary) return false;
                return filterGyms[practice.category];
            });

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            };

            return (
                <div className="min-h-screen p-8">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-bold mb-2 text-orange-400">Gym Time Finder</h1>
                        <p className="text-gray-400 mb-2">Your practice schedule, simplified</p>
                        <p className="text-sm text-gray-500 mb-8">
                            Questions about scheduling? Contact{' '}
                            <a href="mailto:9-12basketball@waawoodbury.org" className="text-orange-400 hover:text-orange-300">
                                9-12basketball@waawoodbury.org
                            </a>
                        </p>

                        <div className="bg-gray-800 rounded-lg p-6 mb-6">
                            <h3 className="text-lg font-semibold mb-4">Load Schedule</h3>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">
                                        Option 1: Paste Google Sheets link (auto-updates)
                                    </label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={spreadsheetUrl}
                                            onChange={(e) => setSpreadsheetUrl(e.target.value)}
                                            placeholder="https://docs.google.com/spreadsheets/d/..."
                                            className="flex-1 px-4 py-2 bg-gray-700 rounded border border-gray-600 focus:border-orange-400 focus:outline-none"
                                        />
                                        <button
                                            onClick={fetchFromUrl}
                                            disabled={loading || !spreadsheetUrl}
                                            className="px-6 py-2 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-600 rounded font-semibold transition-colors"
                                        >
                                            {loading ? 'Loading...' : 'Load'}
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">
                                        Sheet must be publicly accessible (view-only is fine)
                                    </p>
                                </div>

                                <div className="text-center text-gray-500">‚Äî OR ‚Äî</div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-2">
                                        Option 2: Upload CSV file
                                    </label>
                                    <div 
                                        className="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-orange-400 transition-colors cursor-pointer"
                                        onDrop={handleDrop}
                                        onDragOver={(e) => e.preventDefault()}
                                    >
                                        <input
                                            type="file"
                                            accept=".csv"
                                            onChange={handleFileUpload}
                                            className="hidden"
                                            id="fileInput"
                                        />
                                        <label htmlFor="fileInput" className="cursor-pointer">
                                            <div className="text-4xl mb-2">üìÅ</div>
                                            <p className="text-sm">Drop CSV here or click to upload</p>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {lastUpdated && (
                                <p className="text-xs text-gray-500 mt-4">
                                    Last updated: {lastUpdated.toLocaleString()}
                                </p>
                            )}
                        </div>

                        {loading && (
                            <div className="text-center text-xl text-orange-400">
                                Parsing that nightmare spreadsheet...
                            </div>
                        )}

                        {error && (
                            <div className="bg-red-900 border border-red-500 text-red-100 p-4 rounded mb-8">
                                {error}
                            </div>
                        )}

                        {myPractices.length > 0 && (
                            <div className="mb-12">
                                <h2 className="text-3xl font-bold mb-4 text-orange-400">HS Simmons Practices</h2>
                                <div className="bg-gray-800 rounded-lg overflow-hidden">
                                    <table className="w-full">
                                        <thead className="bg-gray-700">
                                            <tr>
                                                <th className="px-4 py-3 text-left">Date</th>
                                                <th className="px-4 py-3 text-left">Location</th>
                                                <th className="px-4 py-3 text-left">Team</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {myPractices.map((practice, idx) => (
                                                <tr key={idx} className="border-t border-gray-700 hover:bg-gray-750">
                                                    <td className="px-4 py-3 font-semibold text-orange-300">
                                                        {formatDate(practice.date)}
                                                    </td>
                                                    <td className="px-4 py-3">{practice.gym}</td>
                                                    <td className="px-4 py-3 text-gray-400">{practice.team}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {openPractices.length > 0 && (
                            <div>
                                <h2 className="text-3xl font-bold mb-4 text-orange-400">HS Open Practice Slots</h2>
                                
                                <div className="bg-gray-800 rounded-lg p-6 mb-6">
                                    <h3 className="text-lg font-semibold mb-4">Filters</h3>
                                    
                                    <div className="mb-4">
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={hideElementary}
                                                onChange={(e) => setHideElementary(e.target.checked)}
                                                className="w-4 h-4"
                                            />
                                            <span>Hide Elementary Schools</span>
                                        </label>
                                    </div>

                                    <div className="space-y-2">
                                        <p className="text-sm text-gray-400 mb-2">Preferred Gyms:</p>
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={filterGyms.eastRidge}
                                                onChange={(e) => setFilterGyms({...filterGyms, eastRidge: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>East Ridge HS</span>
                                        </label>
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={filterGyms.lakeMiddle}
                                                onChange={(e) => setFilterGyms({...filterGyms, lakeMiddle: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>Lake Middle School</span>
                                        </label>
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={filterGyms.oltman}
                                                onChange={(e) => setFilterGyms({...filterGyms, oltman: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>Oltman Middle School</span>
                                        </label>
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={filterGyms.woodburyHS}
                                                onChange={(e) => setFilterGyms({...filterGyms, woodburyHS: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>Woodbury High School</span>
                                        </label>
                                        <label className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={filterGyms.other}
                                                onChange={(e) => setFilterGyms({...filterGyms, other: e.target.checked})}
                                                className="w-4 h-4"
                                            />
                                            <span>Other Gyms</span>
                                        </label>
                                    </div>
                                </div>

                                <div className="bg-gray-800 rounded-lg overflow-hidden">
                                    <table className="w-full">
                                        <thead className="bg-gray-700">
                                            <tr>
                                                <th className="px-4 py-3 text-left">Date</th>
                                                <th className="px-4 py-3 text-left">Location</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredOpenPractices.length === 0 ? (
                                                <tr>
                                                    <td colSpan="2" className="px-4 py-8 text-center text-gray-500">
                                                        No practices match your filters. Try adjusting them above.
                                                    </td>
                                                </tr>
                                            ) : (
                                                filteredOpenPractices.map((practice, idx) => (
                                                    <tr key={idx} className="border-t border-gray-700 hover:bg-gray-750">
                                                        <td className="px-4 py-3 font-semibold text-green-300">
                                                            {formatDate(practice.date)}
                                                        </td>
                                                        <td className="px-4 py-3">{practice.gym}</td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>

                                <p className="text-gray-500 text-sm mt-4">
                                    Showing {filteredOpenPractices.length} of {openPractices.length} HS Open slots
                                </p>
                            </div>
                        )}

                        {myPractices.length === 0 && openPractices.length === 0 && !loading && !error && (
                            <div className="text-center text-gray-500 mt-12">
                                <p className="text-lg">Load a schedule above to get started.</p>
                                <p className="text-sm mt-2">Paste the Google Sheets link or upload the CSV file.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ScheduleParser />, document.getElementById('root'));
    </script>
</body>
</html>