<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAA Basketball Lineup Builder - Simmons 9th/10th</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .builder-panel, .preview-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.3s;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e3c72;
        }
        
        .section-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .section-status.complete {
            background: #d4edda;
            color: #155724;
        }
        
        .section-status.incomplete {
            background: #fff3cd;
            color: #856404;
        }
        
        .section-status.warning {
            background: #f8d7da;
            color: #721c24;
        }
        
        .section-content {
            padding: 15px;
            display: none;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .toggle-icon {
            transition: transform 0.3s;
        }
        
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        
        /* Game Info */
        .game-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }
        
        input, select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Roster Management */
        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .player-chip {
            padding: 10px;
            border: 2px solid #28a745;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .player-chip.available {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .player-chip.unavailable {
            background: #f8d7da;
            border-color: #dc3545;
            opacity: 0.6;
        }
        
        .player-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .player-number {
            font-weight: bold;
            color: #667eea;
        }
        
        /* Period Builder */
        .position-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .position-slot {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 12px;
            min-height: 100px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .position-slot:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .position-slot.filled {
            border: 2px solid #28a745;
            background: #d4edda;
        }
        
        .position-slot.warning {
            border: 2px solid #ffc107;
            background: #fff3cd;
        }
        
        .position-slot.error {
            border: 2px solid #dc3545;
            background: #f8d7da;
        }
        
        .position-label {
            font-weight: bold;
            color: #666;
            font-size: 11px;
            margin-bottom: 8px;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .remove-btn {
            margin-top: 8px;
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        /* Player Selector Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1e3c72;
        }
        
        .player-option {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .player-option.preferred {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .player-option.can-play {
            border-color: #ffc107;
        }
        
        .player-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .player-option.disabled:hover {
            border-color: #e0e0e0;
            background: #f8f9fa;
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-match {
            font-size: 11px;
            color: #666;
        }
        
        .position-match.preferred {
            color: #28a745;
            font-weight: bold;
        }
        
        .close-modal {
            margin-top: 15px;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        /* Action Buttons */
        .action-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        button.warning {
            background: #ffc107;
            color: #000;
        }
        
        button.warning:hover {
            background: #e0a800;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #5a6268;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        /* Live Preview */
        .preview-panel {
            position: sticky;
            top: 10px;
            height: fit-content;
            max-height: calc(100vh - 20px);
        }
        
        .preview-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
        }
        
        .preview-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .preview-table td.has-x {
            font-weight: bold;
        }
        
        /* Mobile Toggle */
        .view-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            gap: 10px;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .main-container,
            .builder-panel,
            .preview-panel,
            button,
            .action-bar,
            .view-toggle {
                display: none !important;
            }
            
            #printableForm {
                display: block !important;
                padding: 20px;
            }
        }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .preview-panel {
                display: none;
            }
            
            .preview-panel.mobile-active {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1500;
                max-height: 100vh;
            }
            
            .builder-panel.mobile-hidden {
                display: none;
            }
            
            .view-toggle {
                display: flex;
            }
            
            .position-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Validation Panel */
        .validation-list {
            font-size: 13px;
        }
        
        .validation-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        
        .validation-item.valid {
            background: #d4edda;
            color: #155724;
        }
        
        .validation-item.invalid {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Game History */
        .saved-games-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
        }
        
        .saved-game-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .saved-game-item:hover {
            background: #e9ecef;
        }
        
        .delete-game {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- BUILDER PANEL -->
        <div class="builder-panel">
            <div class="header">
                <h1>üèÄ WAA BASKETBALL LINEUP BUILDER</h1>
                <div class="subtitle">Simmons 9th/10th - Game Day Planning Tool</div>
            </div>
            
            <div class="content">
                <!-- Game Info Section -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('gameInfo')">
                        <span class="section-title">üìÖ Game Information</span>
                        <span class="toggle-icon" id="gameInfo-icon">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="gameInfo-content">
                        <div class="game-info-grid">
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="gameDate" onchange="saveGameInfo()">
                            </div>
                            <div class="input-group">
                                <label>Time</label>
                                <input type="time" id="gameTime" onchange="saveGameInfo()">
                            </div>
                            <div class="input-group">
                                <label>Opponent</label>
                                <input type="text" id="opponent" placeholder="Team name" onchange="saveGameInfo()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Roster Section -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('roster')">
                        <span class="section-title">üë• Roster Management</span>
                        <span class="section-status" id="roster-status">0 Available</span>
                        <span class="toggle-icon" id="roster-icon">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="roster-content">
                        <div class="roster-grid" id="rosterGrid"></div>
                    </div>
                </div>
                
                <!-- Game History Section -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('history')">
                        <span class="section-title">üìö Game History</span>
                        <span class="toggle-icon" id="history-icon">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="history-content">
                        <div class="action-bar" style="margin-bottom: 15px;">
                            <button onclick="saveCurrentGame()" class="success">üíæ Save Current Game</button>
                            <button onclick="exportGameData()" class="secondary">üì§ Export Backup</button>
                            <input type="file" id="importFile" accept=".json" style="display: none" onchange="importGameData(event)">
                            <button onclick="document.getElementById('importFile').click()" class="secondary">üì• Import Backup</button>
                        </div>
                        <div class="saved-games-list" id="savedGamesList"></div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="action-bar">
                    <button onclick="autoFillLineup()" class="success">üéØ Quick Fill Lineup</button>
                    <button onclick="validateLineups()" class="warning">‚úì Validate Equal Time</button>
                    <button onclick="window.print()">üñ®Ô∏è Print Current Lineup</button>
                    <button onclick="printBlankSheet()" class="secondary">üìÑ Print Blank Sheet</button>
                    <button onclick="clearAllLineups()" class="danger">üóëÔ∏è Clear All</button>
                </div>
                
                <!-- Validation Section -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('validation')">
                        <span class="section-title">‚ö†Ô∏è Playing Time Validation</span>
                        <span class="section-status incomplete" id="validation-status">Not Checked</span>
                        <span class="toggle-icon" id="validation-icon">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="validation-content">
                        <div class="validation-list" id="validationList"></div>
                    </div>
                </div>
                
                <!-- Period Builder -->
                <div id="periodBuilder"></div>
            </div>
        </div>
        
        <!-- PREVIEW PANEL -->
        <div class="preview-panel">
            <div class="header">
                <h1>üìã Live Preview</h1>
                <div class="subtitle">Official WAA Form</div>
            </div>
            <div class="preview-content" id="previewContent"></div>
        </div>
    </div>
    
    <!-- Mobile View Toggle -->
    <div class="view-toggle">
        <button onclick="switchView('builder')">üèÄ Builder</button>
        <button onclick="switchView('preview')">üìã Preview</button>
    </div>
    
    <!-- Player Selector Modal -->
    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Select Player</div>
            <div id="playerOptions"></div>
            <button class="close-modal" onclick="closeModal()">Cancel</button>
        </div>
    </div>
    
    <!-- PRINT-ONLY OFFICIAL WAA FORM -->
    <div id="printableForm" style="display: none;">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="font-size: 20px; font-weight: bold; margin: 0;">WAA BASKETBALL IN-HOUSE PLAYING TIME PLAN</h1>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
                <div style="margin-bottom: 10px;">
                    <strong>TEAM NAME:</strong> <span id="printTeamName" style="border-bottom: 1px solid black; display: inline-block; width: 300px; padding: 2px;"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>DATE:</strong> <span id="printDate" style="border-bottom: 1px solid black; display: inline-block; width: 150px; padding: 2px;"></span>
                    <strong style="margin-left: 20px;">TIME:</strong> <span id="printTime" style="border-bottom: 1px solid black; display: inline-block; width: 100px; padding: 2px;"></span>
                </div>
            </div>
            <div>
                <div style="margin-bottom: 10px;">
                    <strong>COACH:</strong> <span id="printCoach" style="border-bottom: 1px solid black; display: inline-block; width: 300px; padding: 2px;">Derek Simmons</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>GRADE:</strong> <span id="printGrade" style="border-bottom: 1px solid black; display: inline-block; width: 150px; padding: 2px;">9th/10th</span>
                </div>
            </div>
        </div>
        
        <div style="font-size: 11px; margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-left: 4px solid #dc3545;">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> Leave this sheet at the scorer's table prior to the game. If an equal playtime sheet is not prepared at the beginning of the game, the offending team will be issued a technical foul. Each subsequent period the Equal Playtime Sheet is not completed, another technical foul will be issued. All periods (including OT) need to be filled out.
        </div>
        
        <table id="printTable" style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">Player Name</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">Number</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P1</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P2</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P3</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P4</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P5</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P6</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P7</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">P8</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">1st OT</th>
                    <th style="border: 1px solid black; padding: 8px; background: #f0f0f0;">Final OT</th>
                </tr>
            </thead>
            <tbody id="printTableBody"></tbody>
        </table>
        
        <div style="font-size: 10px; line-height: 1.6;">
            <strong>PLAYING TIME RULES:</strong><br>
            <strong>5 players:</strong> Five play 8 periods each and each OT.<br>
            <strong>6 players:</strong> Four play 7 periods (two of these play one OT and two play both OTs) and two play 6 periods and both OTs.<br>
            <strong>7 players:</strong> Five play 6 periods (four of these play 1 OT and one plays both OTs) and two play 5 periods and both OTs.<br>
            <strong>8 players:</strong> Eight play 5 periods each (six play one OT while two play both OTs).<br>
            <strong>9 players:</strong> Five play 4 periods and both OTs; three play one OT and four play 5 periods and no OTs.<br>
            <strong>10 players:</strong> Ten play 4 periods each and one OT each.<br>
            <strong>11 players:</strong> Seven play 4 periods (two of these play in 1 OT) and four play 3 periods and both OTs.<br>
            <strong>12 players:</strong> Eight play 3 periods (six of these play in one OT and two play in both OTs) and four play 4 periods and no OTs.
        </div>
    </div>

    <script>
        // ROSTER DATA
        const ROSTER = [
            {name: 'Tommy', number: 2, positions: [3,2,4,1], available: false},
            {name: 'Dylan', number: 10, positions: [1,2,4,3,5], available: true},
            {name: 'Teegan', number: 13, positions: [5,3,4,2], available: true},
            {name: 'Kabir', number: 22, positions: [4,1,2,5,3], available: true, developAt: 1}, // Natural 4, developing at 1
            {name: 'Caleb', number: 23, positions: [1,4,5,2,3], available: false},
            {name: 'Ben', number: 30, positions: [2,3,1,4], available: true},
            {name: 'Charlie', number: 35, positions: [1,2,3,4], available: true},
            {name: 'Michael', number: 44, positions: [3,4,5,2], available: true},
            {name: 'John', number: 52, positions: [5,4,3,2], available: true},
            {name: 'Dominic', number: 55, positions: [3,4,5,2], available: true}
        ];
        
        const PERIODS = [1, 2, 3, 4, 5, 6, 7, 8, 'OT1', 'OT2'];
        const POSITIONS = ['Point Guard', 'Shooting Guard', 'Small Forward', 'Power Forward', 'Center'];
        
        let lineups = {};
        let currentPeriod = null;
        let currentPosition = null;
        
        // Initialize
        function init() {
            loadFromStorage();
            renderRoster();
            renderPeriodBuilder();
            updatePreview();
            loadSavedGames();
            updateRosterStatus();
        }
        
        // Toggle Section
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }
        
        // Render Roster
        function renderRoster() {
            const grid = document.getElementById('rosterGrid');
            grid.innerHTML = '';
            
            ROSTER.forEach(player => {
                const chip = document.createElement('div');
                chip.className = `player-chip ${player.available ? 'available' : 'unavailable'}`;
                chip.onclick = () => togglePlayerAvailability(player.number);
                
                // Format positions nicely
                const posDisplay = player.positions.slice(0, 3).join('/');
                
                chip.innerHTML = `
                    <div>${player.name}</div>
                    <div class="player-number">#${player.number}</div>
                    <div style="font-size: 10px; color: #666;">${posDisplay}</div>
                `;
                grid.appendChild(chip);
            });
        }
        
        // Toggle Player Availability
        function togglePlayerAvailability(number) {
            const player = ROSTER.find(p => p.number === number);
            player.available = !player.available;
            renderRoster();
            updateRosterStatus();
            saveToStorage();
        }
        
        // Update Roster Status
        function updateRosterStatus() {
            const availableCount = ROSTER.filter(p => p.available).length;
            document.getElementById('roster-status').textContent = `${availableCount} Available`;
        }
        
        // Render Period Builder
        function renderPeriodBuilder() {
            const builder = document.getElementById('periodBuilder');
            builder.innerHTML = '';
            
            PERIODS.forEach(period => {
                const section = document.createElement('div');
                section.className = 'collapsible-section';
                
                const assignments = lineups[period] || {};
                const filledCount = Object.keys(assignments).length;
                const status = filledCount === 5 ? 'complete' : 'incomplete';
                const statusText = `${filledCount}/5 ${filledCount === 5 ? '‚úì' : ''}`;
                
                section.innerHTML = `
                    <div class="section-header" onclick="toggleSection('period${period}')">
                        <span class="section-title">${period.toString().includes('OT') ? period : 'Period ' + period}</span>
                        <span class="section-status ${status}">${statusText}</span>
                        <span class="toggle-icon" id="period${period}-icon">‚ñ∂</span>
                    </div>
                    <div class="section-content" id="period${period}-content">
                        <div class="position-grid" id="period${period}-grid"></div>
                    </div>
                `;
                
                builder.appendChild(section);
                
                // Render positions
                setTimeout(() => renderPositions(period), 0);
            });
        }
        
        // Render Positions for Period
        function renderPositions(period) {
            const grid = document.getElementById(`period${period}-grid`);
            if (!grid) return;
            
            grid.innerHTML = '';
            const assignments = lineups[period] || {};
            
            POSITIONS.forEach((pos, idx) => {
                const position = idx + 1;
                const assigned = assignments[position];
                
                const slot = document.createElement('div');
                let slotClass = 'position-slot';
                
                if (assigned) {
                    const player = ROSTER.find(p => p.number === assigned);
                    const consecutiveCount = checkConsecutivePeriods(player.number, period);
                    
                    if (consecutiveCount >= 3) {
                        slotClass += ' error'; // Red - 3+ in a row
                    } else if (consecutiveCount === 2) {
                        slotClass += ' warning'; // Yellow - 2 in a row
                    } else {
                        slotClass += ' filled'; // Green - normal
                    }
                    
                    slot.className = slotClass;
                    slot.innerHTML = `
                        <div class="position-label">Position ${position}</div>
                        <div class="player-name">${player.name}</div>
                        <div class="player-number">#${player.number}</div>
                        <button class="remove-btn" onclick="removePlayer('${period}', ${position})">Remove</button>
                    `;
                } else {
                    slot.className = slotClass;
                    slot.innerHTML = `
                        <div class="position-label">Position ${position}</div>
                        <div style="color: #999; font-size: 12px;">Click to assign</div>
                    `;
                    slot.onclick = () => openPlayerSelector(period, position);
                }
                
                grid.appendChild(slot);
            });
        }
        
        // Check Consecutive Periods
        function checkConsecutivePeriods(playerNumber, currentPeriod) {
            const regularPeriods = [1, 2, 3, 4, 5, 6, 7, 8];
            const periodIndex = regularPeriods.indexOf(parseInt(currentPeriod));
            
            // OT periods don't count for consecutive checks
            if (periodIndex === -1) return 0;
            
            let consecutive = 1;
            let consecutiveBefore = 0;
            let consecutiveAfter = 0;
            
            // Check backwards
            for (let i = periodIndex - 1; i >= 0; i--) {
                const period = regularPeriods[i];
                const periodLineup = lineups[period] || {};
                const isPlaying = Object.values(periodLineup).includes(playerNumber);
                
                if (isPlaying) {
                    consecutiveBefore++;
                } else {
                    break;
                }
            }
            
            // Check forwards
            for (let i = periodIndex + 1; i < regularPeriods.length; i++) {
                const period = regularPeriods[i];
                const periodLineup = lineups[period] || {};
                const isPlaying = Object.values(periodLineup).includes(playerNumber);
                
                if (isPlaying) {
                    consecutiveAfter++;
                } else {
                    break;
                }
            }
            
            consecutive = 1 + consecutiveBefore + consecutiveAfter;
            
            return consecutive;
        }
        
        // Open Player Selector
        function openPlayerSelector(period, position) {
            currentPeriod = period;
            currentPosition = position;
            
            const modal = document.getElementById('playerModal');
            const title = document.getElementById('modalTitle');
            const options = document.getElementById('playerOptions');
            
            title.textContent = `Select Player - ${period.toString().includes('OT') ? period : 'Period ' + period} - Position ${position}`;
            options.innerHTML = '';
            
            const availablePlayers = ROSTER.filter(p => p.available);
            
            availablePlayers.forEach(player => {
                const usage = getPlayerUsage(player.number);
                const consecutiveCount = checkConsecutivePeriods(player.number, period);
                const maxed = period.toString().includes('OT') ? false : usage >= 5;
                const disabled = maxed; // Only disable if maxed out, NOT for consecutive periods
                
                const isPreferred = player.positions[0] === position;
                const canPlay = player.positions.includes(position);
                
                let optionClass = 'player-option';
                if (disabled) {
                    optionClass += ' disabled';
                } else if (isPreferred) {
                    optionClass += ' preferred';
                } else if (canPlay) {
                    optionClass += ' can-play';
                }
                
                const option = document.createElement('div');
                option.className = optionClass;
                
                let matchText = '';
                if (isPreferred) {
                    matchText = '‚≠ê Primary Position';
                } else if (canPlay) {
                    matchText = '‚úì Can Play';
                } else {
                    matchText = 'Not typical';
                }
                
                // Show warnings but don't block
                let warningText = '';
                if (maxed) {
                    warningText = ' (Max 5 periods)';
                } else if (consecutiveCount >= 3) {
                    warningText = ' ‚ö†Ô∏è (3+ in a row)';
                } else if (consecutiveCount === 2) {
                    warningText = ' ‚ö†Ô∏è (2 in a row)';
                }
                
                option.innerHTML = `
                    <div class="player-info">
                        <div>
                            <strong>${player.name} #${player.number}</strong>
                            <div class="position-match ${isPreferred ? 'preferred' : ''}">${matchText}</div>
                        </div>
                        <div style="text-align: right; font-size: 11px;">
                            <div>${usage}/5 periods${warningText}</div>
                        </div>
                    </div>
                `;
                
                if (!disabled) {
                    option.onclick = () => assignPlayer(player.number);
                }
                
                options.appendChild(option);
            });
            
            modal.classList.add('active');
        }
        
        // Close Modal
        function closeModal() {
            document.getElementById('playerModal').classList.remove('active');
        }
        
        // Assign Player
        function assignPlayer(playerNumber) {
            if (!lineups[currentPeriod]) {
                lineups[currentPeriod] = {};
            }
            
            lineups[currentPeriod][currentPosition] = playerNumber;
            
            saveToStorage();
            renderPositions(currentPeriod);
            updatePreview();
            closeModal();
        }
        
        // Remove Player
        function removePlayer(period, position) {
            if (lineups[period]) {
                delete lineups[period][position];
                saveToStorage();
                renderPositions(period);
                updatePreview();
            }
        }
        
        // Get Player Usage
        function getPlayerUsage(playerNumber) {
            let count = 0;
            [1, 2, 3, 4, 5, 6, 7, 8].forEach(period => {
                if (lineups[period]) {
                    if (Object.values(lineups[period]).includes(playerNumber)) {
                        count++;
                    }
                }
            });
            return count;
        }
        
        // Auto Fill Lineup
        function autoFillLineup() {
            if (!confirm('This will generate a new compliant lineup. Any existing assignments will be replaced. Continue?')) {
                return;
            }
            
            lineups = {};
            const availablePlayers = ROSTER.filter(p => p.available);
            const playerCount = availablePlayers.length;
            
            if (playerCount !== 8) {
                alert(`Auto-fill is optimized for 8 players. You have ${playerCount} available. You can still use it, but you may need to adjust.`);
            }
            
            // Track how many periods each player has played
            const playerSchedules = {};
            availablePlayers.forEach(p => {
                playerSchedules[p.number] = {
                    periods: [],
                    count: 0
                };
            });
            
            // For each period, assign 5 players to positions
            for (let period = 1; period <= 8; period++) {
                lineups[period] = {};
                
                // Find players who need more playing time
                let playersNeedingTime = availablePlayers
                    .filter(p => playerSchedules[p.number].count < 5)
                    .sort((a, b) => {
                        // Sort by: fewest periods played, then by versatility (less versatile first)
                        const countDiff = playerSchedules[a.number].count - playerSchedules[b.number].count;
                        if (countDiff !== 0) return countDiff;
                        return a.positions.length - b.positions.length;
                    });
                
                // Assign players to positions
                const assigned = new Set();
                
                // Strategy: Fill positions 1-5 by finding best fit for each
                for (let pos = 1; pos <= 5; pos++) {
                    let bestPlayer = null;
                    let bestScore = -1;
                    
                    for (let player of playersNeedingTime) {
                        if (assigned.has(player.number)) continue;
                        
                        // Calculate fit score
                        let score = 0;
                        const posIndex = player.positions.indexOf(pos);
                        
                        if (posIndex === -1) {
                            // Can't play this position
                            continue;
                        } else if (posIndex === 0) {
                            // Primary position
                            score = 100;
                        } else if (posIndex === 1) {
                            // Secondary position
                            score = 50;
                        } else {
                            // Can play but not preferred
                            score = 10;
                        }
                        
                        // Bonus for Kabir at point guard (development)
                        if (player.developAt === pos) {
                            score += 30;
                        }
                        
                        // Bonus for specialists (fewer position options)
                        if (player.positions.length <= 2) {
                            score += 20;
                        }
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestPlayer = player;
                        }
                    }
                    
                    // Assign best player
                    if (bestPlayer) {
                        lineups[period][pos] = bestPlayer.number;
                        assigned.add(bestPlayer.number);
                        playerSchedules[bestPlayer.number].periods.push(period);
                        playerSchedules[bestPlayer.number].count++;
                    }
                }
            }
            
            // Handle OT
            // Strategy: 2 players in both OTs, 6 players in one OT each
            const players = [...availablePlayers].sort(() => Math.random() - 0.5); // Randomize
            
            lineups['OT1'] = {};
            lineups['OT2'] = {};
            
            // Assign 2 players to both OTs
            for (let i = 0; i < Math.min(2, players.length); i++) {
                lineups['OT1'][i + 1] = players[i].number;
                lineups['OT2'][i + 1] = players[i].number;
            }
            
            // Assign next 3 to OT1 only
            for (let i = 2; i < Math.min(5, players.length); i++) {
                lineups['OT1'][i + 1] = players[i].number;
            }
            
            // Assign remaining to OT2
            let ot2Pos = 3;
            for (let i = 5; i < players.length && ot2Pos <= 5; i++) {
                lineups['OT2'][ot2Pos] = players[i].number;
                ot2Pos++;
            }
            
            saveToStorage();
            renderPeriodBuilder();
            updatePreview();
            alert('Lineup auto-filled! Review and adjust as needed.');
        }
        
        // Validate Lineups
        function validateLineups() {
            const list = document.getElementById('validationList');
            const status = document.getElementById('validation-status');
            list.innerHTML = '';
            
            let allValid = true;
            const issues = [];
            
            // Check each period has 5 players
            PERIODS.forEach(period => {
                const count = Object.keys(lineups[period] || {}).length;
                if (count !== 5) {
                    issues.push(`${period}: Only ${count}/5 players assigned`);
                    allValid = false;
                }
            });
            
            // Check each available player plays exactly 5 regular periods
            const availablePlayers = ROSTER.filter(p => p.available);
            availablePlayers.forEach(player => {
                const usage = getPlayerUsage(player.number);
                if (usage !== 5) {
                    issues.push(`${player.name} #${player.number}: Playing ${usage}/5 periods`);
                    allValid = false;
                }
            });
            
            // Check OT distribution (2 in both, 6 in one each)
            const ot1Players = Object.values(lineups['OT1'] || {});
            const ot2Players = Object.values(lineups['OT2'] || {});
            const inBothOTs = ot1Players.filter(p => ot2Players.includes(p));
            
            if (inBothOTs.length !== 2) {
                issues.push(`Overtime: ${inBothOTs.length} players in both OTs (need exactly 2)`);
                allValid = false;
            }
            
            if (issues.length === 0) {
                list.innerHTML = '<div class="validation-item valid">‚úì All playing time rules met!</div>';
                status.textContent = '‚úì Valid';
                status.className = 'section-status complete';
            } else {
                issues.forEach(issue => {
                    const item = document.createElement('div');
                    item.className = 'validation-item invalid';
                    item.textContent = '‚úó ' + issue;
                    list.appendChild(item);
                });
                status.textContent = `${issues.length} Issues`;
                status.className = 'section-status warning';
            }
            
            // Expand validation section
            document.getElementById('validation-content').classList.add('expanded');
            document.getElementById('validation-icon').classList.add('expanded');
        }
        
        // Clear All Lineups
        function clearAllLineups() {
            if (confirm('Clear all lineups? This cannot be undone.')) {
                lineups = {};
                saveToStorage();
                renderPeriodBuilder();
                updatePreview();
            }
        }
        
        // Update Live Preview
        function updatePreview() {
            const preview = document.getElementById('previewContent');
            const availablePlayers = ROSTER.filter(p => p.available).sort((a, b) => a.number - b.number);
            
            let html = '<table class="preview-table"><thead><tr>';
            html += '<th>Player</th><th>#</th>';
            [1,2,3,4,5,6,7,8].forEach(p => html += `<th>P${p}</th>`);
            html += '<th>1st OT</th><th>Final OT</th></tr></thead><tbody>';
            
            availablePlayers.forEach(player => {
                html += `<tr><td>${player.name}</td><td>${player.number}</td>`;
                
                [1,2,3,4,5,6,7,8,'OT1','OT2'].forEach(period => {
                    const periodLineup = lineups[period] || {};
                    const isPlaying = Object.values(periodLineup).includes(player.number);
                    html += `<td class="${isPlaying ? 'has-x' : ''}">${isPlaying ? 'X' : ''}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
        }
        
        // Mobile View Switching
        function switchView(view) {
            const builder = document.querySelector('.builder-panel');
            const preview = document.querySelector('.preview-panel');
            
            if (view === 'builder') {
                builder.classList.remove('mobile-hidden');
                preview.classList.remove('mobile-active');
            } else {
                builder.classList.add('mobile-hidden');
                preview.classList.add('mobile-active');
            }
        }
        
        // Save/Load from Storage
        function saveToStorage() {
            localStorage.setItem('waa_lineups', JSON.stringify(lineups));
        }
        
        function loadFromStorage() {
            const saved = localStorage.getItem('waa_lineups');
            if (saved) {
                lineups = JSON.parse(saved);
            }
            
            // Load game info
            const date = localStorage.getItem('waa_game_date');
            const time = localStorage.getItem('waa_game_time');
            const opponent = localStorage.getItem('waa_opponent');
            
            if (date) document.getElementById('gameDate').value = date;
            if (time) document.getElementById('gameTime').value = time;
            if (opponent) document.getElementById('opponent').value = opponent;
        }
        
        function saveGameInfo() {
            localStorage.setItem('waa_game_date', document.getElementById('gameDate').value);
            localStorage.setItem('waa_game_time', document.getElementById('gameTime').value);
            localStorage.setItem('waa_opponent', document.getElementById('opponent').value);
            updatePreview();
        }
        
        // Game History Management
        function saveCurrentGame() {
            const date = document.getElementById('gameDate').value;
            const opponent = document.getElementById('opponent').value;
            
            if (!date || !opponent) {
                alert('Please enter game date and opponent name first.');
                return;
            }
            
            const gameName = `${opponent} - ${date}`;
            const gameData = {
                name: gameName,
                date: date,
                time: document.getElementById('gameTime').value,
                opponent: opponent,
                lineups: lineups
            };
            
            const games = JSON.parse(localStorage.getItem('waa_saved_games') || '[]');
            games.push(gameData);
            localStorage.setItem('waa_saved_games', JSON.stringify(games));
            
            loadSavedGames();
            alert(`Game saved: ${gameName}`);
        }
        
        function loadSavedGames() {
            const list = document.getElementById('savedGamesList');
            const games = JSON.parse(localStorage.getItem('waa_saved_games') || '[]');
            
            if (games.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No saved games yet</div>';
                return;
            }
            
            list.innerHTML = '';
            games.forEach((game, idx) => {
                const item = document.createElement('div');
                item.className = 'saved-game-item';
                item.innerHTML = `
                    <span onclick="loadGame(${idx})" style="flex: 1; cursor: pointer;">${game.name}</span>
                    <button class="delete-game" onclick="deleteGame(${idx})">Delete</button>
                `;
                list.appendChild(item);
            });
        }
        
        function loadGame(index) {
            const games = JSON.parse(localStorage.getItem('waa_saved_games') || '[]');
            const game = games[index];
            
            if (!game) return;
            
            document.getElementById('gameDate').value = game.date;
            document.getElementById('gameTime').value = game.time;
            document.getElementById('opponent').value = game.opponent;
            lineups = game.lineups;
            
            saveToStorage();
            saveGameInfo();
            renderPeriodBuilder();
            updatePreview();
            
            alert(`Loaded: ${game.name}`);
        }
        
        function deleteGame(index) {
            if (!confirm('Delete this saved game?')) return;
            
            const games = JSON.parse(localStorage.getItem('waa_saved_games') || '[]');
            games.splice(index, 1);
            localStorage.setItem('waa_saved_games', JSON.stringify(games));
            loadSavedGames();
        }
        
        function exportGameData() {
            const games = JSON.parse(localStorage.getItem('waa_saved_games') || '[]');
            const dataStr = JSON.stringify(games, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `waa_lineups_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function importGameData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const games = JSON.parse(e.target.result);
                    localStorage.setItem('waa_saved_games', JSON.stringify(games));
                    loadSavedGames();
                    alert('Games imported successfully!');
                } catch (err) {
                    alert('Error importing file. Make sure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
        }
        
        // Print Functions
        function generatePrintTable() {
            const tbody = document.getElementById('printTableBody');
            const availablePlayers = ROSTER.filter(p => p.available).sort((a, b) => a.number - b.number);
            
            // Fill available players
            let html = '';
            availablePlayers.forEach((player, idx) => {
                html += `<tr><td style="border: 1px solid black; padding: 6px; text-align: left;">${idx + 1}. ${player.name}</td>`;
                html += `<td style="border: 1px solid black; padding: 6px;">${player.number}</td>`;
                
                [1,2,3,4,5,6,7,8,'OT1','OT2'].forEach(period => {
                    const periodLineup = lineups[period] || {};
                    const isPlaying = Object.values(periodLineup).includes(player.number);
                    html += `<td style="border: 1px solid black; padding: 6px;">${isPlaying ? 'X' : ''}</td>`;
                });
                
                html += '</tr>';
            });
            
            // Fill empty rows to reach 12
            for (let i = availablePlayers.length; i < 12; i++) {
                html += `<tr><td style="border: 1px solid black; padding: 6px;">${i + 1}.</td>`;
                html += `<td style="border: 1px solid black; padding: 6px;"></td>`;
                for (let j = 0; j < 10; j++) {
                    html += `<td style="border: 1px solid black; padding: 6px;"></td>`;
                }
                html += '</tr>';
            }
            
            tbody.innerHTML = html;
            
            // Populate header info
            const opponent = document.getElementById('opponent').value;
            document.getElementById('printTeamName').textContent = opponent ? `Simmons 9th/10th vs ${opponent}` : 'Simmons 9th/10th';
            
            // Restore coach and grade for regular print
            document.getElementById('printCoach').textContent = 'Derek Simmons';
            document.getElementById('printGrade').textContent = '9th/10th';
            
            const dateInput = document.getElementById('gameDate').value;
            if (dateInput) {
                const [year, month, day] = dateInput.split('-');
                document.getElementById('printDate').textContent = `${month}-${day}-${year}`;
            } else {
                document.getElementById('printDate').textContent = '_______________';
            }
            
            const timeInput = document.getElementById('gameTime').value;
            if (timeInput) {
                const [hours, minutes] = timeInput.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const hour12 = hour % 12 || 12;
                document.getElementById('printTime').textContent = `${hour12}:${minutes} ${ampm}`;
            } else {
                document.getElementById('printTime').textContent = '__________';
            }
        }
        
        function printBlankSheet() {
            // Save current lineups
            const savedLineups = {...lineups};
            
            // Clear lineups for blank sheet
            lineups = {};
            
            // Generate blank table with ALL roster players (not just available)
            const tbody = document.getElementById('printTableBody');
            const allPlayers = [...ROSTER].sort((a, b) => a.number - b.number); // All 10 players in numerical order
            
            let html = '';
            allPlayers.forEach((player, idx) => {
                html += `<tr><td style="border: 1px solid black; padding: 6px; text-align: left;">${idx + 1}. ${player.name}</td>`;
                html += `<td style="border: 1px solid black; padding: 6px;">${player.number}</td>`;
                
                // Empty cells for all periods
                for (let j = 0; j < 10; j++) {
                    html += `<td style="border: 1px solid black; padding: 6px;"></td>`;
                }
                
                html += '</tr>';
            });
            
            // Fill empty rows to reach 12
            for (let i = allPlayers.length; i < 12; i++) {
                html += `<tr><td style="border: 1px solid black; padding: 6px;">${i + 1}.</td>`;
                html += `<td style="border: 1px solid black; padding: 6px;"></td>`;
                for (let j = 0; j < 10; j++) {
                    html += `<td style="border: 1px solid black; padding: 6px;"></td>`;
                }
                html += '</tr>';
            }
            
            tbody.innerHTML = html;
            
            // Blank out ALL header fields for blank sheet
            document.getElementById('printTeamName').textContent = '_______________________________________________';
            document.getElementById('printDate').textContent = '_______________';
            document.getElementById('printTime').textContent = '__________';
            document.getElementById('printCoach').textContent = '_______________________________________________';
            document.getElementById('printGrade').textContent = '_______________';
            
            // Print
            setTimeout(() => {
                window.print();
                
                // Restore lineups and regenerate regular print table
                lineups = savedLineups;
                generatePrintTable();
            }, 100);
        }
        
        // Override window.print
        const originalPrint = window.print;
        window.print = function() {
            generatePrintTable();
            originalPrint.call(window);
        };
        
        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>